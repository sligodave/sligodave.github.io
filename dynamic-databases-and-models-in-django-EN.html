<!DOCTYPE html>
<html lang="EN" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Dynamic Databases and Models in Django - sligodave.com</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://sligodave.com/dynamic-databases-and-models-in-django-EN.html">

        <meta name="author" content="David Higgins" />
        <meta name="keywords" content="software,python,django" />
        <meta name="description" content="A walk through of how I implemented the ability to dynamically add database configurations and subsequent connections to a running Django instance. Along with dynamically creating model classes to access the tables of the added connections." />

        <meta property="og:site_name" content="sligodave.com" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Dynamic Databases and Models in Django"/>
        <meta property="og:url" content="http://sligodave.com/dynamic-databases-and-models-in-django-EN.html"/>
        <meta property="og:description" content="A walk through of how I implemented the ability to dynamically add database configurations and subsequent connections to a running Django instance. Along with dynamically creating model classes to access the tables of the added connections."/>
        <meta property="article:published_time" content="2016-07-23" />
            <meta property="article:section" content="Software" />
            <meta property="article:tag" content="software" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="django" />
            <meta property="article:author" content="David Higgins" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://sligodave.com/theme/css/bootstrap.united.min.css" type="text/css"/>
    <link href="http://sligodave.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://sligodave.com/theme/css/pygments/tango.css" rel="stylesheet">
    <link rel="stylesheet" href="http://sligodave.com/theme/css/style.css" type="text/css"/>

        <link href="http://sligodave.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="sligodave.com ATOM Feed"/>



        <link href="http://sligodave.com/feeds/software.atom.xml" type="application/atom+xml" rel="alternate"
              title="sligodave.com Software ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://sligodave.com/" class="navbar-brand">
sligodave.com            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="http://sligodave.com/category/software.html">Software</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://sligodave.com/dynamic-databases-and-models-in-django-EN.html"
                       rel="bookmark"
                       title="Permalink to Dynamic Databases and Models in Django">
                        Dynamic Databases and Models in Django
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-07-23T16:24:10-06:00"> Sat 23 July 2016</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="http://sligodave.com/category/software.html">Software</a>


<span class="label label-default">Tags</span>
	<a href="http://sligodave.com/tag/software.html">software</a>
        /
	<a href="http://sligodave.com/tag/python.html">python</a>
        /
	<a href="http://sligodave.com/tag/django.html">django</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>I recently found myself working on an internal site to aid developers when working across deployments of the same databases but in different environments. For example the same set of databases in a production, testing and development environment.</p>
<p>I wanted to give a user the ability to select which environment they wanted to work against and then be able to automatically allow for subtle differences in their table structures where new features may be present in one environment but not in another.</p>
<p>I decided that in order to achieve this, I had to firstly store configurations for database connections but in a dynamic manner where the configurations could be added and removed as needed.</p>
<p>So I went with a basic model to represent a database connection.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">jsonfield</span> <span class="kn">import</span> <span class="n">JSONField</span>


<span class="k">class</span> <span class="nc">Database</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">JSONField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</pre></div>


<p>Simple! We give each a unique name that would usually represent the key in the settings.DATABASES dictionary. The json is what would usually be the value. A dictionary to provide details of the database connection. Host, database name etc.</p>
<p>Once I had that, I then registered the <code>Database</code> model with the Admin.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dumps</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">dynamic_databases.models</span> <span class="kn">import</span> <span class="n">Database</span>


<span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;Config&#39;</span>


<span class="k">class</span> <span class="nc">DatabaseAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>


<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Database</span><span class="p">,</span> <span class="n">DatabaseAdmin</span><span class="p">)</span>
</pre></div>


<p>Again, so far simple enough. We have a model and it's accessible through the admin to add, edit or remove dynamic database references.</p>
<p>Next up is the ability to register the databases with the running Django instance and to then access the tables of that database as models in Django.</p>
<p>Firstly I added a method to the <code>Database</code> class that I could call and pass a table name and expect to get back a fully functioning Model class.</p>
<p>So I added a method called <code>get_model</code> to the <code>Database</code> class and it took one parameter. The name of a table.</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
        <span class="o">...</span>
</pre></div>


<p>The first thing that it did was call another new method that ensured that the database connection was registered with Django. There's no point in trying to get a model class if we can't connect to the database it resides on. We'll also require a dummy container app for each database connection. Model classes
need to be registered with an app. So for us we'll have an app per dynamic database. So more than one database can have tables by the same name.</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># label for the database connection and dummy app</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
        <span class="c1"># Do we have this database registered yet</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">_databases</span><span class="p">:</span>
            <span class="c1"># Register the database</span>
            <span class="n">connections</span><span class="o">.</span><span class="n">_databases</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
            <span class="c1"># Break the cached version of the database dict so it&#39;ll find our new database</span>
            <span class="k">del</span> <span class="n">connections</span><span class="o">.</span><span class="n">databases</span>
        <span class="c1"># Have we registered our fake app that&#39;ll hold the models for this database</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">apps</span><span class="o">.</span><span class="n">app_configs</span><span class="p">:</span>
            <span class="c1"># We create our own AppConfig class, because the Django one needs a path to the module that is the app.</span>
            <span class="c1">#Our dummy app obviously doesn&#39;t have a path</span>
            <span class="n">AppConfig2</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span>
                <span class="s1">&#39;AppConfig&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">AppConfig</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/tmp/{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">)}</span>
            <span class="p">)</span>
            <span class="n">app_config</span> <span class="o">=</span> <span class="n">AppConfig2</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="c1"># Manually register the app with the running Django instance</span>
            <span class="n">apps</span><span class="o">.</span><span class="n">app_configs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">app_config</span>
            <span class="n">apps</span><span class="o">.</span><span class="n">app_configs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We want to be able to identify the dynamic databases and apps</span>
        <span class="c1"># So we prepend their names with a common string</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;DYNAMIC_DATABASES_PREFIX&#39;</span><span class="p">,</span> <span class="s1">&#39;DYNAMIC_DATABASE&#39;</span><span class="p">)</span>
        <span class="n">separator</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;DYNAMIC_DATABASES_SEPARATOR&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;{}{}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
</pre></div>


<p>Now things are starting to take shape. We have the ability to register our database connection and also the app it needs to store the models in.
Next we need to get the table structure and create a model that represents it.
It'll then be placed in our dummy app. Lets got back and flesh out our <code>get_model</code> method</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="c1"># Ensure the database connect and it&#39;s dummy app are registered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Is the model already registered with the dummy app?</span>
        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">apps</span><span class="o">.</span><span class="n">all_models</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding dynamic model: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>

            <span class="c1"># Use the &quot;inspectdb&quot; management command to get the structure of the table for us.</span>
            <span class="n">file_obj</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="n">Command</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">file_obj</span><span class="p">)</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span>
                <span class="n">database</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">table_name_filter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span> <span class="o">==</span> <span class="n">table_name</span>
            <span class="p">)</span>
            <span class="n">model_definition</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="n">file_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># Make sure that we found the table and have a model definition</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">model_definition</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;(models.Model):&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loc</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Ensure that the Model has a primary key.</span>
                <span class="c1"># Django doesn&#39;t support multiple column primary keys,</span>
                <span class="c1"># So we have to add a primary key if the inspect command didn&#39;t</span>
                <span class="k">if</span> <span class="n">model_definition</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;primary_key&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">loc</span> <span class="o">=</span> <span class="n">model_definition</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="n">loc</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span>
                    <span class="n">model_definition</span> <span class="o">=</span> <span class="s1">&#39;{}primary_key=True, {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">model_definition</span><span class="p">[:</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">model_definition</span><span class="p">[</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                    <span class="p">)</span>
                <span class="c1"># Ensure that the model specifies what app_label it belongs to</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">model_definition</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;db_table = </span><span class="se">\&#39;</span><span class="s1">{}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">loc</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">model_definition</span> <span class="o">=</span> <span class="s1">&#39;{}app_label = </span><span class="se">\&#39;</span><span class="s1">{}</span><span class="se">\&#39;\n</span><span class="s1">        {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">model_definition</span><span class="p">[:</span><span class="n">loc</span><span class="p">],</span> <span class="n">label</span><span class="p">,</span> <span class="n">model_definition</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span>
                    <span class="p">)</span>

                <span class="c1"># Register the model with Django. Sad day when we use &#39;exec&#39;</span>
                <span class="k">exec</span><span class="p">(</span><span class="n">model_definition</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">())</span>
                <span class="c1"># Update the list of models that the app</span>
                <span class="c1"># has to match what Django now has for this app</span>
                <span class="n">apps</span><span class="o">.</span><span class="n">app_configs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">apps</span><span class="o">.</span><span class="n">all_models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not find table: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Already added dynamic model: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>

        <span class="c1"># If we have the connection, app and model. Return the model class</span>
        <span class="k">if</span> <span class="p">(</span>
                <span class="n">label</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">_databases</span> <span class="ow">and</span>
                <span class="n">label</span> <span class="ow">in</span> <span class="n">apps</span><span class="o">.</span><span class="n">all_models</span> <span class="ow">and</span>
                <span class="n">model_name</span> <span class="ow">in</span> <span class="n">apps</span><span class="o">.</span><span class="n">all_models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
</pre></div>


<p>Just to keep everything above board, here are the imports you'll also need in your <code>models.py</code></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">getLogger</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="kn">from</span> <span class="nn">django.core.management.commands.inspectdb</span> <span class="kn">import</span> <span class="n">Command</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">connections</span>
<span class="kn">from</span> <span class="nn">django.apps</span> <span class="kn">import</span> <span class="n">AppConfig</span>
<span class="kn">from</span> <span class="nn">django.apps.registry</span> <span class="kn">import</span> <span class="n">apps</span>

<span class="kn">from</span> <span class="nn">jsonfield</span> <span class="kn">import</span> <span class="n">JSONField</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;dynamic_databases.models&#39;</span><span class="p">)</span>
</pre></div>


<p>Next we need a router in order to tell django what database connection to use for what model classes. I created a <code>router.py</code> file in my <code>dynamic_databases</code> app.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>


<span class="k">class</span> <span class="nc">DynamicDatabasesRouter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># We need to identify our dynamic models</span>
    <span class="c1"># and point them in the right direction</span>
    <span class="n">label_prefix</span> <span class="o">=</span> <span class="s1">&#39;{}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;DYNAMIC_DATABASES_PREFIX&#39;</span><span class="p">,</span> <span class="s1">&#39;DYNAMIC_DATABASE&#39;</span><span class="p">),</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;DYNAMIC_DATABASES_SEPARATOR&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_prefix</span><span class="p">):</span>
            <span class="c1"># We know that our app_label matches the database connection&#39;s name</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_prefix</span><span class="p">):</span>
            <span class="c1"># We know that our app_label matches the database connection&#39;s name</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">allow_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">allow_migrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>


<p>You can register your new router in your settings file with something like the following:</p>
<div class="highlight"><pre><span></span><span class="n">DATABASE_ROUTERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dynamic_databases.router.DynamicDatabasesRouter&#39;</span><span class="p">]</span>
</pre></div>


<p>At this stage you'd be good to go. Create a database instance and call <code>get_model</code> on it to get a model class that represents a table in your dynamic database connection.</p>
<p>There is one more thing we can allow for though. What about if a database instance is altered or deleted? Shouldn't we remove the connection, app and models? I think so.</p>
<p>For this we'll need to listen for some signals and act when we are invoked.
I created a file called <code>receivers.py</code> in my app. It listened for any save or delete on a Database model instance. It looked like this:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">pre_save</span><span class="p">,</span> <span class="n">pre_delete</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>

<span class="kn">from</span> <span class="nn">dynamic_databases.models</span> <span class="kn">import</span> <span class="n">Database</span>


<span class="nd">@receiver</span><span class="p">([</span><span class="n">pre_save</span><span class="p">,</span> <span class="n">pre_delete</span><span class="p">],</span> <span class="n">sender</span><span class="o">=</span><span class="n">Database</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unregister_database</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;instance&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unregister</span><span class="p">()</span>
</pre></div>


<p>You'll notice that it's calling a method called <code>unregister</code> that we haven't written yet. So lets. You could probably look at the <code>get_model</code> and <code>register</code> methods and figure out what needs to be undone. Once you have it, you add the method to the <code>Database</code> model class.</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">unregister</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Unregistering Database, app and all related models: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">apps</span><span class="o">.</span><span class="n">app_configs</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">apps</span><span class="o">.</span><span class="n">app_configs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">apps</span><span class="o">.</span><span class="n">all_models</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">apps</span><span class="o">.</span><span class="n">all_models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">_databases</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">connections</span><span class="o">.</span><span class="n">_databases</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">connections</span><span class="o">.</span><span class="n">databases</span>
</pre></div>


<p>No we need to make sure that our receiver is registered so it is invoked when the correct changes occur. We can put the import of the receiver in our <code>dynamic_databases</code> <code>apps.py</code> file.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">from</span> <span class="nn">django.apps</span> <span class="kn">import</span> <span class="n">AppConfig</span>


<span class="k">class</span> <span class="nc">DynamicDatabasesConfig</span><span class="p">(</span><span class="n">AppConfig</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;dynamic_databases&#39;</span>

    <span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">dynamic_databases.receivers</span>
</pre></div>


<p>We also need to register this class so that Django knows that it represents our <code>dynamic_databses</code> app. In the app's <code>__init__.py</code> file we add the following:</p>
<div class="highlight"><pre><span></span><span class="n">default_app_config</span> <span class="o">=</span> <span class="s1">&#39;dynamic_databases.apps.DynamicDatabasesConfig&#39;</span>
</pre></div>


<p>So there you have it.</p>
<p>We can</p>
<ul>
<li>Store dynamic database connections.</li>
<li>Add, update and delete through the admin interface.</li>
<li>Get model classes that represent the tables in the dynamic databases</li>
<li>We can update the dynamically registered classes as changes are made to our dynamic database model instances.</li>
<li>We can now try it out...</li>
</ul>
<p>I created a test project, added the app and ran the migrations.</p>
<p>I then created a view to do something very very basic.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">TemplateView</span>

<span class="kn">from</span> <span class="nn">dynamic_databases.models</span> <span class="kn">import</span> <span class="n">Database</span>


<span class="k">class</span> <span class="nc">HomeView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>

    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">HomeView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">()</span>

        <span class="c1"># We can pick which dynamic database connection we want based on a GET parameter</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Pass the database instance to the template so we can display it.</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span>

        <span class="c1"># Get a model class for a table in our dynamic database.</span>
        <span class="c1"># Lets pretend there&#39;s a table called &#39;author&#39;</span>
        <span class="n">Author</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span>
        <span class="n">authors</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="c1"># Send the author instances to the template for iterating over.</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">authors</span>

        <span class="k">return</span> <span class="n">context</span>
</pre></div>


<p>A simple <code>home.html</code> can go something like this:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">table</span> <span class="na">border</span><span class="o">=</span><span class="s">&quot;1&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Name<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Book Count<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
{% for author in authors %}
            <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ author.name }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ author.book_count }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
{% endfor %}
        <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>


<p>It's important to recognize the limitations here.
We haven't touched on the fact that there is no <code>ContentType</code> instance that corresponds to our model classes. So a lot of machinery won't work there.
We could also create an instance of <code>ContentType</code> whenever we add a new model but I haven't gone that far yet. Let me know how you get on, if you give it a whirl.</p>
<p>Please feel free to ask questions or to tell me that this is flaky and will blow up in my face. It was fun digging into the code and getting it working all the same. Even if it's not recommended for production use because I've missed something fundamental.</p>
<p>So ultimately, <strong>use at your own risk</strong>.</p>
            </div>
            <!-- /.entry-content -->
    <hr />
    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
            <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    </div>
    <!-- AddThis Button END -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'sligodavecom'; // required: replace example with your forum shortname

                    var disqus_identifier = 'dynamic-databases-and-models-in-django';
                var disqus_url = 'http://sligodave.com/dynamic-databases-and-models-in-django-EN.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sligodave"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sligodave"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
                <li class="list-group-item"><a href="https://www.linkedin.com/in/sligodave"><i class="fa fa-linkedin-square fa-lg"></i> LinkedIn</a></li>
              </ul>
            </li>

            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
                <ul class="list-group" id="recentposts">
                    <li class="list-group-item">
                        <a href="http://sligodave.com/dynamic-databases-and-models-in-django-EN.html">
                            Dynamic Databases and Models in Django
                        </a>
                    </li>
                </ul>
            </li>

            <li class="list-group-item"><a href="http://sligodave.com/"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Categories</span></h4></a>
                <ul class="list-group" id="categories">
                    <li class="list-group-item">
                        <a href="http://sligodave.com/category/software.html">
                            <i class="fa fa-folder-open fa-lg"></i> Software
                        </a>
                    </li>
                </ul>
            </li>

            <li class="list-group-item"><a href="http://sligodave.com/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags">
                    <li class="list-group-item tag-4">
                        <a href="http://sligodave.com/tag/django.html">
                            django
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://sligodave.com/tag/python.html">
                            python
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://sligodave.com/tag/software.html">
                            software
                        </a>
                    </li>
                </ul>
            </li>


    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 David Higgins
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://sligodave.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://sligodave.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://sligodave.com/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'sligodavecom'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-43444229-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

        <script type="text/javascript">var addthis_config = {"data_track_addressbar": true};</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-512f8ea07bf30d8a"></script>
</body>
</html>